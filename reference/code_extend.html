<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Extending codes — code_extend • manydata</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Extending codes — code_extend"><meta name="description" content="These functions use text embeddings and multinomial logistic regression
to suggest missing codes or flag potentially incorrect codes based on text data.
Two approaches are provided: one using GloVe embeddings trained on the input text,
and another using pre-trained BERT embeddings via the {text} package.
Both functions require a vector of text (e.g., titles or descriptions)
and a corresponding vector of categorical codes, with NA or empty strings
indicating missing codes to be inferred.
The functions train a multinomial logistic regression model
using glmnet on the text embeddings of the entries with known codes,
and then predict codes for the entries with missing codes.
The functions also validate the model's performance
on a holdout set and report per-class precision, recall, and F1-score.
If no missing codes are present, the functions instead
check existing codes for potential mismatches and report them."><meta property="og:description" content="These functions use text embeddings and multinomial logistic regression
to suggest missing codes or flag potentially incorrect codes based on text data.
Two approaches are provided: one using GloVe embeddings trained on the input text,
and another using pre-trained BERT embeddings via the {text} package.
Both functions require a vector of text (e.g., titles or descriptions)
and a corresponding vector of categorical codes, with NA or empty strings
indicating missing codes to be inferred.
The functions train a multinomial logistic regression model
using glmnet on the text embeddings of the entries with known codes,
and then predict codes for the entries with missing codes.
The functions also validate the model's performance
on a holdout set and report per-class precision, recall, and F1-score.
If no missing codes are present, the functions instead
check existing codes for potential mismatches and report them."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">manydata</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Go to home"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-other-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Other packages</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-other-packages"><li><a class="external-link dropdown-item" href="https://globalgov.github.io/manypkgs/">manypkgs</a></li>
    <li><a class="external-link dropdown-item" href="https://globalgov.github.io/manystates/">manystates</a></li>
    <li><a class="external-link dropdown-item" href="https://globalgov.github.io/manytreaties/">manytreaties</a></li>
    <li><a class="external-link dropdown-item" href="https://globalgov.github.io/manyios/">manyios</a></li>
  </ul></li>
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/globalgov/manydata" aria-label="View on Github"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Extending codes</h1>
      <small class="dont-index">Source: <a href="https://github.com/globalgov/manydata/blob/main/R/code_extend.R" class="external-link"><code>R/code_extend.R</code></a></small>
      <div class="d-none name"><code>code_extend.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>These functions use text embeddings and multinomial logistic regression
to suggest missing codes or flag potentially incorrect codes based on text data.
Two approaches are provided: one using GloVe embeddings trained on the input text,
and another using pre-trained BERT embeddings via the <code>{text}</code> package.
Both functions require a vector of text (e.g., titles or descriptions)
and a corresponding vector of categorical codes, with <code>NA</code> or empty strings
indicating missing codes to be inferred.
The functions train a multinomial logistic regression model
using <code>glmnet</code> on the text embeddings of the entries with known codes,
and then predict codes for the entries with missing codes.
The functions also validate the model's performance
on a holdout set and report per-class precision, recall, and F1-score.
If no missing codes are present, the functions instead
check existing codes for potential mismatches and report them.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">code_extend_glove</span><span class="op">(</span><span class="va">titles</span>, <span class="va">var</span>, req_f1 <span class="op">=</span> <span class="fl">0.8</span>, rarity_threshold <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">code_extend_bert</span><span class="op">(</span><span class="va">titles</span>, <span class="va">var</span>, req_f1 <span class="op">=</span> <span class="fl">0.8</span>, rarity_threshold <span class="op">=</span> <span class="fl">8</span>, <span class="va">emb_texts</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-titles">titles<a class="anchor" aria-label="anchor" href="#arg-titles"></a></dt>
<dd><p>A character vector of text entries (e.g., titles or descriptions).</p></dd>


<dt id="arg-var">var<a class="anchor" aria-label="anchor" href="#arg-var"></a></dt>
<dd><p>A character vector of (categorical) codes that might be coded
from the titles or texts.
Entries with missing codes should be <code>NA_character_</code> or empty strings.
The function will suggest codes for these entries.
If no missing codes are present, the function will check existing codes
for potential mismatches.</p></dd>


<dt id="arg-req-f-">req_f1<a class="anchor" aria-label="anchor" href="#arg-req-f-"></a></dt>
<dd><p>The required macro-F1 score on the validation set
before proceeding with inference.
Default is 0.80.</p></dd>


<dt id="arg-rarity-threshold">rarity_threshold<a class="anchor" aria-label="anchor" href="#arg-rarity-threshold"></a></dt>
<dd><p>Minimum number of occurrences for a code
to be included in training.
Codes with fewer occurrences are excluded from training
to ensure sufficient data for learning.
Default is 8.</p></dd>


<dt id="arg-emb-texts">emb_texts<a class="anchor" aria-label="anchor" href="#arg-emb-texts"></a></dt>
<dd><p>For <code>code_extend_bert()</code>, pre-computed embeddings
from <code>text::textEmbed()</code>.
This avoids re-computing embeddings if they have already been computed.
A Hugging Face model can be specified via the <code>model</code> argument.
Default is "sentence-transformers/all-MiniLM-L6-v2".
Other models can be used, but they should produce
sentence-level embeddings.</p></dd>

</dl></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">titles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">emperors</span><span class="op">$</span><span class="va">Wikipedia</span><span class="op">$</span><span class="va">CityBirth</span>,</span></span>
<span class="r-in"><span>                <span class="va">emperors</span><span class="op">$</span><span class="va">Wikipedia</span><span class="op">$</span><span class="va">ProvinceBirth</span>,</span></span>
<span class="r-in"><span>                <span class="va">emperors</span><span class="op">$</span><span class="va">Wikipedia</span><span class="op">$</span><span class="va">Rise</span>,</span></span>
<span class="r-in"><span>                <span class="va">emperors</span><span class="op">$</span><span class="va">Wikipedia</span><span class="op">$</span><span class="va">Dynasty</span>,</span></span>
<span class="r-in"><span>                <span class="va">emperors</span><span class="op">$</span><span class="va">Wikipedia</span><span class="op">$</span><span class="va">Cause</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">var</span> <span class="op">&lt;-</span> <span class="va">emperors</span><span class="op">$</span><span class="va">Wikipedia</span><span class="op">$</span><span class="va">Killer</span></span></span>
<span class="r-in"><span><span class="va">var</span><span class="op">[</span><span class="va">var</span><span class="op">==</span><span class="st">"Unknown"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></span>
<span class="r-in"><span><span class="va">var</span><span class="op">[</span><span class="va">var</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Senate"</span>,<span class="st">"Court Officials"</span>,<span class="st">"Opposing Army"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Enemies"</span></span></span>
<span class="r-in"><span><span class="va">var</span><span class="op">[</span><span class="va">var</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Fire"</span>,<span class="st">"Lightning"</span>,<span class="st">"Aneurism"</span>,<span class="st">"Heart Failure"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"God"</span></span></span>
<span class="r-in"><span><span class="va">var</span><span class="op">[</span><span class="va">var</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Wife"</span>,<span class="st">"Usurper"</span>,<span class="st">"Praetorian Guard"</span>,<span class="st">"Own Army"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Friends"</span></span></span>
<span class="r-in"><span><span class="va">glo</span> <span class="op">&lt;-</span> <span class="fu">code_extend_glove</span><span class="op">(</span><span class="va">titles</span>, </span></span>
<span class="r-in"><span>           <span class="va">var</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Training GloVe model.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.960] epoch 1, loss 0.3661</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.978] epoch 2, loss 0.1794</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.983] epoch 3, loss 0.0667</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.984] epoch 4, loss 0.0330</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.985] epoch 5, loss 0.0219</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.986] epoch 6, loss 0.0149</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.987] epoch 7, loss 0.0107</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.988] epoch 8, loss 0.0078</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.989] epoch 9, loss 0.0058</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.991] epoch 10, loss 0.0044</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.992] epoch 11, loss 0.0034</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.993] epoch 12, loss 0.0026</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.994] epoch 13, loss 0.0020</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.996] epoch 14, loss 0.0016</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.997] epoch 15, loss 0.0013</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.998] epoch 16, loss 0.0010</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:17.999] epoch 17, loss 0.0008</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:18.000] epoch 18, loss 0.0007</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:18.001] epoch 19, loss 0.0005</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> INFO  [10:13:18.002] epoch 20, loss 0.0004</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Found 6 missing codes to infer.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Removing God codes from training data as they have fewer than 8 occurrences.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Training glmnet with 'logscaled' weights.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>one multinomial or binomial class has fewer than 8  observations; dangerous ground</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>one multinomial or binomial class has fewer than 8  observations; dangerous ground</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>one multinomial or binomial class has fewer than 8  observations; dangerous ground</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>one multinomial or binomial class has fewer than 8  observations; dangerous ground</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>one multinomial or binomial class has fewer than 8  observations; dangerous ground</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>one multinomial or binomial class has fewer than 8  observations; dangerous ground</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>one multinomial or binomial class has fewer than 8  observations; dangerous ground</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BB00;">✔</span> Model trained with 'logscaled' weights.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Validating on 13 observations.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Macro-F1 = 0.818 with 'logscaled' weights.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BB00;">✔</span> Sufficient model found. Macro-F1 = 0.818 with 'logscaled' weights.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Proceeding with inference.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BB00;">✔</span> Predicted 6 missing codes</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>manydata</p>
</div>

<div class="pkgdown-footer-right">
  <p>Part of the <a href="https://panarchic.ch/" class="external-link">PANARCHIC project</a>.</p>
</div>

    </footer></div>





  </body></html>

